<!DOCTYPE html>
<meta charset="utf-8">
<style>
#soundwall-wrapper{
   width:1024px;
  height: 768px;
  display: block;
  position: relative;
  margin: 0 auto;
}
#profile{ width:24px;
  }
#social {
  width:1024px;
  margin:2%;
  height:150px;
  background-color: rgba(255, 255, 255, 0.5);
  position: absolute;
  z-index:30;
}
#msg {
  float: left;
  width:800px;
}
#name {
float:left;
font-family: Helvetica, Arial, sans-serif;
font-size: 22px;
color:#FF0000;
font-weight:700;
}
#pic, #twitter {
  float:left;
}
#icon {
  width:24px;
}
#tweet {
  font-size:22px;
  font-family: Helvetica, Arial, sans-serif;
  font-weight:200;
  color:#808080;
  float:left;
}
#time{
  float:left;
}
#us-map {
  width:1024px;
  height: 768px;
  display: block;
  position: absolute;
}
#pulsate {
  z-index: 40;
  width:1024px;
  height: 768px;
  display: block;
  position:absolute;
  z-index:40;
}

.land {
  fill: #DDDDDD;
}

.county-boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}

.state-boundary {
  fill: none;
  stroke: #fff;
  stroke-width:2;
}

.graticule {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}

.dot {
  fill: #FF0000;
}

.ring {
  fill: none;
  stroke: #FF0000;
}
#photo {
  max-width:150px;
}
#pic {
  width:150px;
  margin-right:15px;
}
#time {
  font-size:18px;
  font-family: Helvetica, Arial, sans-serif;
  font-weight:200;
  color:#FF0000;
}
</style>
<body>
<div id="soundwall-wrapper">
    <div id="social">
        <div id="pic">
            <img id="photo" />
        </div>
        <div id="msg">
          <div id="twitter">
              <img id="icon" />
          </div>
        <div id="name"></div><br />
        <div id="tweet"></div>
        <div id="tags"></div>
        <div id="time"></div>
    </div>
    <div id="us-map"></div>
    <div id="pulsate"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/1.1.29/howler.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script></script>
<script>
var tweets;
var size;
var newTweet;
var location;
var coords;

window.onload = function loadTweet() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (xhttp.readyState == 4 && xhttp.status == 200) {
      tweets = JSON.parse(xhttp.responseText);
      size = Number(tweets.length);
      newTweet = tweets[3];
      locateUser = newTweet.tweet.location;
      msDate = Number(newTweet.tweet.timestamp_ms);
      function readDate(date) {
        var months = ['Jan', ';Feb', 'Mar', 'Apr', 'May', 'Jun','Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var hrs = date.getUTCHours() == 0 ? 12 : (date.getUTCHours() > 12 ? date.getUTCHours() - 12 : date.getUTCHours());
        var min = date.getUTCMinutes() < 10 ? '0' + date.getUTCMinutes() : date.getUTCMinutes();
        var ampm = date.getUTCHours() < 12 ? 'AM' : 'PM';
          return months[date.getUTCMonth()] + ' ' + date.getUTCDate() + ',' + ' ' + date.getUTCFullYear() + ' ' + hrs + ':' + min + ' ' + ampm;
      }
      var readableDate = readDate(new Date(msDate));
      
      var str = newTweet.payload,
      reg = /@EatMorChikin|#chickfila|#eatmorchikin|@ChickfilA/ig; //g is to replace all occurances

      //fixing a bit
      var toStr = String(reg);
      var color = (toStr.replace('\/g', '|')).substring(1);

      //split it baby
      var colors = color.split("|");

      if (colors.indexOf("@ChickfilA") > -1) {
          str = str.replace(/@ChickfilA/g, '<span style="color:#FF0000; font-weight:700;">@ChickfilA</span>');
      }


      document.getElementById("time").innerHTML = readableDate;
      document.getElementById("tweet").innerHTML = str;
      document.getElementById("icon").src = "twitter.png";
      document.getElementById("photo").src = newTweet.tweet.entities.media[0].media_url;
      document.getElementById("name").innerHTML = "@" + newTweet.tweet.user.screen_name + ' ' + '|' + ' ' + newTweet.tweet.user.name; 
    }
  };

  xhttp.open("GET", "http://twitter-cfa.mybluemix.net/view-tweets?limit=10", true);
  xhttp.send();
}
</script>
<script>
var width = 1024,
    height = 768;

var projection = d3.geo.albersUsa()
    .scale(1000)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var graticule = d3.geo.graticule()
    .step([5, 5]);

var svg = d3.select("#pulsate").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", path);

svg.append("circle")
    .attr("class", "dot")
    .attr("transform", "translate(" + projection([-71, 42]) + ")")
    .attr("r", 2000)
  .transition()
    .ease("linear")
    .attr("r", 8)
    .delay(500)
    .duration(2500);

setInterval(function() {
  svg.append("circle")
      .attr("class", "ring")
      .attr("transform", "translate(" + projection([-71, 42]) + ")")
      .attr("r", 6)
      .style("stroke-width", 3)
      .style("stroke", "#FF0000")
    .transition()
      .ease("linear")
      .duration(6000)
      .style("stroke-opacity", 1e-6)
      .style("stroke-width", 1)
      .style("stroke", "#FF0000")
      .attr("r", 160)
      .remove();
}, 750);

var svg1 = d3.select("#us-map").append("svg")
    .attr("width", width)
    .attr("height", height);


d3.json("https://raw.githubusercontent.com/stamen/ecoengine/master/prototypes/covis/us.json", function(error, us) {
  if (error) throw error;

  svg.insert("path", ".graticule")
      .datum(topojson.feature(us, us.objects.land))
      .attr("class", "land")
      .attr("d", path);

  svg.insert("path", ".graticule")
      .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a !== b && !(a.id / 1000 ^ b.id / 1000); }))
      .attr("class", "county-boundary")
      .attr("d", path);

  svg.insert("path", ".graticule")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "state-boundary")
      .attr("d", path);
});

d3.select(self.frameElement).style("height", height + "px");

</script>
